{% from 'editable.html' import editable_text %}
{% extends "base.html" %}

{% block title %}Mission - {{ super() }}{% endblock %}

{% block content %}
<h5><a href="{{ url_for('roster', team_id=team) }}">{{ team.name }}</a></h5>

<div>
{% if is_captain and not team.mission %}
<div class="modal fade" id="confirm-start-modal" tabindex="-1" role="dialog" aria-labelledby="confirmStartOverlayTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title text-center" id="confirmStartOverlayTitle">Are you sure?</h3>
      </div>
      <div class="modal-body">
        <p>Commit your team to this mission for the next {{ mission.duration_in_weeks }} weeks?
        <p>Note: You will be unable to customize the mission after starting.
        (You can still make a copy and customize for a later run.)
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <a id="confirm-start" class="btn btn-danger btn-ok">Start</a>
      </div>
    </div>
  </div>
</div>
<form style="display: inline-block"
      id="start-form"
      action="{{ url_for('mission', team_id=team, mission_id=mission) }}"
      method="POST">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="start_mission" value="1">
  <button id="start" type="submit" class="btn btn-primary"><i class="fas fa-play"></i>&nbsp;Start mission</button>
</form>
{% endif %}
{% if is_captain and mission.frozen %}
<form style="display: inline-block"
      action="{{ url_for('mission', team_id=team, mission_id=mission) }}"
      method="POST">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="copy" value="1">
  <button type="submit" class="btn btn-primary"><i class="fas fa-copy"></i>&nbsp;Copy and customize</button>
</form>
{% endif %}
</div>

{% set can_edit = is_captain and not mission.frozen %}
<h3>{{ editable_text(text=mission.title,
                     is_editable=can_edit,
                     popup_title="Edit title",
                     table="mission", id=mission.id, field="title") }}</h3>
<!--
<p><a href="{{ url_for('show_mission_info', mission_id=mission.id) }}">MISSION BRIEF HERE</a></p>
-->
<p>{{ editable_text(text=mission.short_description,
                    is_editable=can_edit,
                    multiline=True,
                    popup_title="Edit description",
                    table="mission", id=mission.id, field='short_description') }}</p>

{% if week_of_mission > 0 and week_of_mission <= mission.duration_in_weeks %}
<p>Click "Pledge" below for any goals you want to complete. Afterwards, click the "Done" checkbox to mark goals you have completed.
<p>In week {{ week_of_mission }}!
<p><a class="btn btn-primary" data-toggle="collapse" href="#calendar" role="button" aria-expanded="false" aria-controls="calendar">Toggle calendar</a>
<div class="collapse" id="calendar">
{% include 'calendar.html' %}
</div>
{% elif team.mission %}
<p>Your crew is currently on <a href="{{ url_for('mission', team_id=team, mission_id=team.mission) }}">another mission</a>. (Crews can only be signed up for one mission at a time.)
{% elif not is_captain %}
<p>Your captain must start this mission before you can begin. Afterwards, return here each week to pledge for goals and track your progress.
{% elif is_captain and not team.mission %}
{% if team_size < 2 %}
<p>You need some crew before you can start a mission.
Invite people <a href="{{ url_for('roster', team_id=team, _anchor='invite') }}">here</a>.
{% else %}
<p>During this month long mission, your crew will attempt the goals below. You
should encourage each person to pledge for and complete as many goals as
possible. At the start of every week, a new primary goal will open
up&mdash;this is a good time to check in. Some bonus, secondary goals may be
completed at any time during the mission.
{% endif %}
{% endif %}

<div class="row">
<section class="primary col-sm-6">
<h4>Primary Goals</h4>
{% for week in range(1,5): %} 
<h5>Week {{ week }}</h5>
{% for slot in mission.goal_slots(week=week): %}
{% set goal = slot.goal %}
{% set active = week_of_mission > 0 and week_of_mission <= 4 and week_of_mission >= week %}
{% include "goal.html" %}
{% endfor %}
{% endfor %}
</section>

<section class="bonus col-sm-6">
<h4>Secondary Goals</h4>
<h5>Any time</h5>
{% for slot in mission.goal_slots(week=0): %}
{% set goal = slot.goal %}
{% set active = week_of_mission > 0 and week_of_mission <= 4 %}
{% include "goal.html" %}
{% endfor %}
</section>
</div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
{% if is_captain and not team.mission %}
$('#start').click(function(e) {
  $('#confirm-start-modal').modal({keyboard: true});
  e.preventDefault();
  return false;
});

$('#confirm-start').click(function() {
  $('#start-form').submit();
})
{% endif %}

function updateProgress(goalDiv) {
  var progress = goalDiv.find('.goal-progress-wrapper');
  var updateUrl = progress.data('update-url')
  $.ajax(updateUrl).done(function(html) {
    $(progress).html(html);
  });
}

$('.pledge').click(function() {
  var goalDiv = $(this).parents('.goal');
  $.post('/pledge', {
    'goal_id': goalDiv.data('goal')
  }).done(function(json) {
    if (json['ok']) {
      var pledgeControls = goalDiv.find('.pledge-controls');
      pledgeControls.removeClass('nonpledged').addClass('pledged');
      updateProgress(goalDiv);
    }
  });
  return false;
});

$('.done').click(function() {
  var goalDiv = $(this).parents('.goal');
  var progressDiv = goalDiv.find('.goal-progress');
  var pledgeId = progressDiv.data('my-pledge');
  var checked = $(this).prop('checked');
  $.post('/edit', {
    'table': 'pledge',
    'field': 'fulfilled',
    'id': pledgeId,
    'value': checked
  }).done(function(json) {
    if (json['ok']) {
      updateProgress(goalDiv);
    }
  });
});
</script>
{% endblock %}
