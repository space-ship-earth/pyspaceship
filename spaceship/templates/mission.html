{% extends "base.html" %}

{% block title %}Mission - {{ super() }}{% endblock %}

{% block content %}
<h5>
    <a href="{{ url_for('roster', team_id=team) }}"> {{ team.name }} </a>
</h5>

<h3>{{ mission.title }}</h3>
{% if week_of_mission > 0 and week_of_mission <= 4 %}
<p>Click "Pledge" below for any goals you want to complete. Afterwards, click the "Done" checkbox to mark goals you have completed.
<p>In week {{ week_of_mission }}!
<p><a class="btn btn-primary" data-toggle="collapse" href="#calendar" role="button" aria-expanded="false" aria-controls="calendar">Toggle calendar</a>
<div class="collapse" id="calendar">
{% include 'calendar.html' %}
</div>
{% elif team.mission %}
<p>Your crew is currently on <a href="{{ url_for('mission', team_id=team, mission_id=team.mission) }}">another mission</a>. (Crews can only be signed up for one mission at a time.)
{% elif not is_captain %}
<p>Your captain must start this mission before you can begin. Afterwards, return here each week to pledge for goals and track your progress.
{% elif is_captain and not team.mission %}
{% if team_size < 2 %}
<p>You need some crew before you can start a mission.
Invite people <a href="{{ url_for('roster', team_id=team, _anchor='invite') }}">here</a>.
{% else %}
<p>During this month long mission, your crew will attempt the goals below. You
should encourage each person to pledge for and complete as many goals as
possible. At the start of every week, a new primary goal will open
up&mdash;this is a good time to check in. Some bonus, secondary goals may be
completed at any time during the mission.

<p>Commit your crew to this mission for one month?
<form method="POST" class="needs-validation" novalidate>
  {% for field in start_mission %}
  {% set errors = start_mission.errors[field.name] %}
  {% if field.flags.hidden %}
    {{ field(class="form-control") }}
  {% elif field.type == "SubmitField" %}
    {{ field(class="btn btn-primary") }}
  {% else %}
    {% if errors %}
    {% set class="form-control is-invalid" %}
    {% else %}
    {% set class="form-control" %}
    {% endif %}

    <div class="row">
      <span class="col-3">{{ field.label() }}</span>
    </div>
    <div class="row form-box">
      <span class="col-6">
      {{ field(class=class) }}
      <div class="invalid-feedback">
        {{ ';'.join(errors) }}
      </div>
      {{ field.description }}
      </span>
    </div>
  {% endif %}
  {% endfor %}
</form>
{% endif %}
{% endif %}

<div class="row">
<section class="primary col-sm-6">
<h4>Primary Goals</h4>
{% for week in range(1,5): %} 
<h5>Week {{ week }}</h5>
{% for goal in mission.goals: %}
{% if goal.week == week and goal.primary_for_mission %}
{% include "goal.html" %}
{% endif %}
{% endfor %}
{% endfor %}
</section>

<section class="bonus col-sm-6">
<h4>Secondary Goals</h4>
<h5>Any time</h5>
{% for goal in mission.goals: %}
{% if not goal.primary_for_mission %}
{% include "goal.html" %}
{% endif %}
{% endfor %}
</section>
</div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function updateProgress(goalDiv) {
  var progress = goalDiv.find('.goal-progress');
  var updateUrl = progress.data('update-url')
  $.ajax(updateUrl).done(function(html) {
    $(progress).html(html);
  });
}

$('.pledge').click(function() {
  var goalDiv = $(this).parents('.goal');
  $.post('/pledge', {
    'goal_id': goalDiv.data('goal')
  }).done(function(json) {
    if (json['ok']) {
      var pledgeControls = goalDiv.find('.pledge-controls');
      pledgeControls.removeClass('nonpledged').addClass('pledged');
      updateProgress(goalDiv);
    }
  });
  return false;
});

$('.done').click(function() {
  var goalDiv = $(this).parents('.goal');
  var progressDiv = goalDiv.find('.progress');
  var pledgeId = progressDiv.data('my-pledge');
  var checked = $(this).prop('checked');
  $.post('/edit', {
    'table': 'pledge',
    'field': 'fulfilled',
    'id': pledgeId,
    'value': checked
  }).done(function(json) {
    if (json['ok']) {
      updateProgress(goalDiv);
    }
  });
});
</script>
{% endblock %}
