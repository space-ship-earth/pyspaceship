{% extends "base.html" %}

{% block title %}Missions - {{ super() }}{% endblock %}

{% macro render_mission(mission) -%}

  {% set goal = mission.goals[0] %}

  {% if goal %}
  {% set goal_info = goal.goal_info %}
  <div class="card" style="max-width: 18rem;">
    <div class="card-header">
      <a href="{{ url_for('mission', mission_uuid=mission.uuid) }}">
        {{ goal_info['name'] }}
      </a>
    </div>

    <img src="{{ goal_info['icon'] }}" class="card-img-top" alt="{{ goal['alt'] }}">

    <div class="card-body">
      <h5 class="card-title">
        {% if mission.is_running %}
        Day {{ mission.mission_day }} of {{ mission.duration_in_days }}
        {% elif mission.is_upcoming %}
        T-MINUS {{mission.days_until_start}} days
        {% else %}
        COMPLETED {{ mission.start_time.format('MMMM Do') }}
        {% endif %}
      </h5>

      <div class="card-text card-group">
        {% for user in mission.team.members %}
        <div>
          <a class="text-center p-1" role="button" href="{{ url_for('profile', user_id=user.id) }}">
            <div>
              <img src="{{ gravatar(user.email, size=64) }}"  height="64">
            </div>
            <div>
              {{ user.name }}
              {% if user == mission.team.captain %}
              <span class="badge badge-success">Captain</span>
              {% endif %}
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

{%- endmacro %}

{% block content %}
<h3>Welcome <a href="{{ url_for('profile', user_id=current_user.id) }}">{{ current_user.name.split(" ")[0] }}</a>! </h3>

<div class="missions">

  {% if active_missions|length %}
  <div class="card mb-3">
    <div class="card-header">
      <h2 class="mb-0">Active Missions</h2>
    </div>

    <div class="card-body">
      <div class="card-deck">

        {% for mission in active_missions %}
        {{ render_mission(mission) }}
        {% endfor %}
       </div>
    </div>
  </div>
  {% endif %}

  <div class="card" id="new-mission">
    <div class="card-header">
      <h2>New Mission</h3>
    </div>

    <div class="card-body">
      <p>Select a goal for your new mission</p>

      <div class="accordion" id="accordionExample">
        <div class="card" v-for="(cat_info, category) in goals">
          <div class="card-header" id="heading-{{ category }}">
            <h3 class="mb-0">
              [[ cat_info.title ]]
            </h3>
          </div>

          <div class="card-body">
            <p>
              [[ cat_info.description ]]
            </p>

            <div class="card-deck">
              <div class="card" style="max-width: 18rem;" v-for="goal in cat_info.goals">
                <img :src="goal.icon" class="card-img-top" alt="goal.alt">
                <div class="card-body">
                  <h5 class="card-title"> [[ goal.name ]] </h5>
                  <p class="card-text">
                    [[ goal.description ]]
                  </p>

                  <p>
                    Read more at:
                    <ul>
                      <li v-for="link in goal.links">
                        <a :href="link.url">[[ link.title ]]</a>
                      </li>
                    </ul>
                  </p>

                  <div class="card-footer text-right">
                    <form method="POST" action="/mission/create" class="form-row">
                      <input type="hidden" name="category" :value="category" />
                      <input type="hidden" name="goal" :value="goal.name" />
                      <input type="hidden" name="csrf_token" :value="csrfToken" />

                      <button type="submit" class="btn btn-primary">Create Mission</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if completed_missions|length %}
  <div class="card mt-3">
    <div class="card-header">
      <h2 class="mb-0">Past Missions</h2>
    </div>

    <div class="card-body">
      <div class="card-deck">

        {% for mission in completed_missions %}
        {{ render_mission(mission) }}
        {% endfor %}
       </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
  const goals = {{ goals | tojson }};
  const missionCreator = new Vue({
    el: '#new-mission',
    delimiters: ['[[', ']]'],
    data: {
      csrfToken: window.csrfToken,
      goals,
    },
    computed: {
      goalSelected: function() { return this.goal === null; }
    },
  });
</script>

{% endblock %}
